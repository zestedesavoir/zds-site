{% extends "article/base.html" %}
{% load emarkdown %}
{% load markup %}
{% load humane_date %}
{% load profile %}
{% load crispy_forms_tags %}

{% block title %}
    {{ article.title }}
{% endblock %}

{% block headline %}
    <a href="{{ article.get_absolute_online_url }}">{{ article.title }}</a><br />
    <small>{{ article.description }}</small>
{% endblock %}

{% block breadcrumb %}
    <li class="current"><a href="#">{{ article.title }}</a></li>
{% endblock %}

{% block headline-actions %}
    {% if tags %}
    <div class="mobile-menu-bloc mobile-all-links mobile-show-ico" data-title="Tags">
        <h3>Tags</h3>
        <ul>
        {% for category in tags.all %}
            <li><a href="{% url "zds.article.views.index" %}?tag={{category.title}}">{{ category.title }}</a></li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if authors %}
    <div class="mobile-menu-bloc mobile-all-links mobile-show-ico" data-title="Contributeurs">
        <h3>Contributeurs</h3>
        <ul>
        {% for author in authors.all %}
            {% with profile=author|profile %}
            <li><a href="{{ author.get_absolute_url }}">{{ author.username }}</a></li>
            {% endwith %}
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if perms.article.change_article %}
    <form action="{% url "zds.article.views.modify" %}" method="post">
        <div class="mobile-menu-bloc mobile-all-links mobile-show-ico" data-title="Administrations">
            <h3>Admin<span class="wide">istration</span></h3>
            <ul>
                <li><a href="{{ article.get_absolute_url }}">Version offline</a></li>
                <li><button type="submit" name="invalid-article">Confirmer la dépublication</button></li>
                <li><a href="{% url "zds.article.views.history_validation" article.pk %}">Historique validation</a></li>
            </ul>
        </div>

        <input type="hidden" name="article" value="{{ article.pk }}" />
        <input type="hidden" name="version" value="{{ version }}" />
        {% csrf_token %}
    </form>
    {% endif %}

    <div class="mobile-menu-bloc mobile-all-links mobile-show-ico" data-title="Télécharger">
        <h3>Télécharger</h3>
        <ul>
            <li><a href="{% url "zds.article.views.download" %}?article={{ article.pk }}">Archive</a></li>
        </ul>
    </div>
{% endblock %}

{% block content %}

{% if article.is_visible %}
    {% include "article/view_pager.part.html" %}
{% endif %}

<div class="row">
    <div class="large-12 columns">
        {{ article.txt|safe }}
    </div>
</div>

{% include "article/view_pager.part.html" %}


<h1>Réactions</h1>
    {% with topic=article %}
    {% include "forum/topic_pagination.part.html" with position="top" %}
    {% endwith %}
{% for reaction in reactions %}
<article class="forum-message">
    <div class="user" id="p{{ reaction.id }}">
        <a href="{{ reaction.author.get_absolute_url }}" class="avatar-link">
            {% with profile=reaction.author|profile %}
            <img src="{{ profile.get_avatar_url }}" alt="" class="avatar">
            {% endwith %}
        </a>
    </div>
    <div class="message">
        {% if user.is_authenticated %}
        <ul class="message-actions">
            {% if reaction.author = user or perms.article.change_reaction %}
            <li><a href="{% url "zds.article.views.edit_reaction" %}?message={{ reaction.pk }}" class="ico-after edit">Editer</a></li>
            {% endif %}
            <li><a href="#" class="ico-after alert">Signaler</a></li>
            {% if not article.is_locked and not article.antispam %}
            <li><a href="{% url "zds.article.views.answer" %}?article={{ article.pk }}&amp;cite={{ reaction.pk }}" class="ico-after cite">Citer</a></li>
            {% endif %}
        </ul>
        {% endif %}

        <div class="message-metadata">
            <a href="{{ reaction.author.get_absolute_url }}" class="username">{{ reaction.author.username }}</a>
            <a href="#p{{ reaction.pk }}" class="date">{{ reaction.pubdate|humane_date }}</a>
            {% if not reaction.is_visible %}
                <i>Masqué par {{ reaction.editor }} : {{ reaction.text_hidden }}</i>
            {% elif not reaction.update = None %}
                <i>(Edité {{ reaction.update|humane_date }} par {{ reaction.editor }} )</i>
            {% endif %}
        </div>

        <div class="message-content">
            {{ reaction.text|emarkdown }}
        </div>

        <div class="message-bottom">
            {% with profile=reaction.author|profile %}
                <p class="signature"> {{profile.sign|emarkdown_inline}} </p>
            {% endwith %}
            {% if user.is_authenticated %}
            <div class="message-karma">
                <a href="{% url "zds.article.views.like_reaction" %}?message={{ reaction.pk }}" class="upvote {% if reaction.like > reaction.dislike %}voted{% endif%} ico-after">+{{reaction.like}}</a>
                <a href="{% url "zds.article.views.dislike_reaction" %}?message={{ reaction.pk }}" class="downvote {% if reaction.like < reaction.dislike %}voted{% endif%} ico-after">-{{reaction.dislike}}</a>
            </div>
            {% endif %}
        </div>
    </div>
</article>
{% endfor %}

{% with topic=article %}
{% include "forum/topic_pagination.part.html" with position="bottom" %}
{% endwith %}

{% if user.is_authenticated %}
{% with profile=user|profile%}
<section>
    <div class="user">
        <img src="{{profile.get_avatar_url}}" alt="" class="avatar avatar-link">
    </div>
    {% crispy form %}
</section>
{% endwith %}
{% endif %}
{% endblock %}

